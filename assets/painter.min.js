/**
 * Painter 
 * version 0.1.0 
 * Xhao Sun <sunxuhao@gmail.com> 
 * 2013-04-02 10:34:51
 */
(function(){var t=function(t,e,i,s){this.type=t,this.pos=e,this.zindex=i,this.obj={},this.canvas=null,this.ready=!1,this.id=0,"Text"==this.type?(this.text=s.text||"",this.property={font:s.font,bold:s.bold||"normal",color:s.color||"#000000",size:s.size||12},s.fontObj?this.loadFont(s.fontObj):s.fontSrc?this.loadFont(s.fontSrc):s.font?this.ready=!0:(this.property.font="Microsoft Yahei",this.ready=!0)):"Image"==this.type&&(this.property={},s.image?(this.loadImage(s.image),this.src=s.image.src):(this.loadImage(s.src),this.src=s.src),this.width=s.width||0,this.height=s.height||0)};t.prototype={setCavans:function(t){return this.canvas=t,this},setPos:function(t){return this.pos=t,this},getPos:function(){return this.pos},setZindex:function(t){return this.zindex=t,this},getZindex:function(){return this.zindex},setText:function(t){for(v in t)"text"==v||"font"==v||"bold"==v||"color"==v||"size"==v?this.property[v]=t[v]:("fontSrc"==v||"fontObj"==v)&&this.loadFont(t[v]);return this},setImage:function(t){return t.image?(this.loadImage(t.image),this.src=t.image.src):(this.loadImage(t.src),this.src=t.src),this},setId:function(t){return this.id=t,this},draw:function(){if(!this.canvas)return this;var t=this;return setTimeout(function(){t.ready?"Text"==t.type?t._drawHandlerText():"Image"==t.type&&t._drawHandlerImage():setTimeout(arguments.callee,10)},10),this},onDrawComplete:function(){},_drawHandlerText:function(){var t=this.canvas;t.textBaseline="top",t.font=this.property.bold+" "+this.property.size+"px "+this.property.font,t.fillStyle=this.property.color,t.fillText(this.text,this.pos.x,this.pos.y),this.onDrawComplete()},_drawHandlerImage:function(){var t=this.canvas;t.drawImage(this.obj.image,this.pos.x,this.pos.y,this.width,this.height),this.onDrawComplete()},loadFont:function(t){var e=this;if(e.ready=!1,"string"==typeof t)var i=new Font(t);else var i=t;i.bindload(function(){e.property.font=i.name,e.obj.font=i,e.ready=!0}).load()},loadImage:function(t){var e=this;if(e.ready=!1,"string"==typeof t)var i=new Image,s=t;else var i=t,s=i.src;i.onload=function(){e.obj.image=i,e.property.width=i.width,e.property.height=i.height,e.ready=!0,e.width=e.width||i.width,e.height=e.height||i.height},i.src=s}};var e=function(t,e){this.id=t||"Painter"+(0|999999*Math.random()),e=e||{width:100,height:100},this.width=e.width,this.height=e.height,this.canvas=null,this.ctx=null,this.layerList=[],this.idCount=0,this.eventList={},this._createCanvas()};e.prototype={add:function(e,i,s,n){if("Text"!=e&&"Image"!=e)return this;s=s||{x:0,y:0},n=n||0;var r=new t(e,s,n,i);return r.setId(this.idCount++).setCavans(this.ctx),this.layerList.push(r),r.id},del:function(t){var e="number"==typeof t||"string"==typeof t?Number(t):t.id;return i.arrIndexOfByKey(this.layerList,"id",e),i.arrRmEle(this.layerList,e),this},set:function(t,e,i){switch(("number"==typeof t||"string"==typeof t)&&(t=this.find(t)),e){case"x":var s=t.getPos().y;t.setPos({x:i,y:s});break;case"y":var n=t.getPos().x;t.setPos({x:n,y:i});break;case"pos":t.setPos(i);break;case"zindex":t.setZindex(i);break;case"text":t.setText({text:i});break;case"color":t.setText({color:i});break;case"size":t.setText({size:i});break;case"bold":t.setText({bold:i});break;case"font":t.setText({fontObj:i});break;case"image":t.setImage({src:i})}return this},sets:function(t,e){("number"==typeof t||"string"==typeof t)&&(t=this.find(t));for(v in e)this.set(t,v,e[v]);return this},find:function(t){var e=i.arrIndexOfByKey(this.layerList,"id",t);return this.layerList[e]},render:function(t){return t.appendChild(this.canvas),this},draw:function(){this.clean(),i.arrSortByKey(this.layerList,"zindex"),this._draw(0)},clean:function(){return this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this},on:function(t,e){return t?(e=e||function(){},this.eventList[t]=this.eventList[t]||[],this.eventList[t].push(e),this):this},un:function(t){return t?(this.eventList[t]=[],this):this},_doEvent:function(t){this.eventList[t]=this.eventList[t]||[];for(var e=0;this.eventList[t].length>e;e++)this.eventList[t][e]()},_draw:function(t){var e=this;this.layerList[t].onDrawComplete=function(){e.layerList.length-1>t?e._draw(t+1):e._doEvent("drawComplete")},this.layerList[t].draw()},_createCanvas:function(){var t=document.createElement("canvas"),e=t.getContext("2d");t.id=this.id,t.width=this.width,t.height=this.height,this.canvas=t,this.ctx=e}};var i={arrRmEle:function(t,e){return t.splice(e,1),t},arrSortByKey:function(t,e,i){i===void 0&&(i=!0);for(var s=0;t.length-1>s;s++)for(var n=0;t.length-s-1>n;n++)if(t[n][e]>t[n+1][e]){var r=t[n];t[n]=t[n+1],t[n+1]=r}return i||t.reverse(),t},arrIndexOfByKey:function(t,e,i){for(var s=0;t.length>s;s++)if(t[s][e]===i)return s;return-1}};window.Painter=e})();